<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Ebook.Views.LibraryPage"
    x:Name="Root"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Библиотека">

    <Grid Padding="16" RowDefinitions="Auto,Auto,*">

        <Entry
            Grid.Row="0"
            Placeholder="Поиск по названию..."
            Text="{Binding SearchQuery}" />

        <HorizontalStackLayout
            Grid.Row="1"
            Margin="0,10,0,10"
            HorizontalOptions="Center">

            <Button
                Text="Импорт"
                Command="{Binding ImportCommand}" />
        </HorizontalStackLayout>

        <CollectionView
            Grid.Row="2"
            ItemsSource="{Binding Books}"
            SelectionMode="None">

            <CollectionView.ItemsLayout>
                <GridItemsLayout Orientation="Vertical" Span="2" />
            </CollectionView.ItemsLayout>

            <CollectionView.ItemTemplate>
                <DataTemplate>

                    <Frame
                        Padding="8"
                        Margin="6"
                        BackgroundColor="{StaticResource CardColor}"
                        CornerRadius="12"
                        HasShadow="True">

                        <VerticalStackLayout Spacing="6">

                            <Image
                                HeightRequest="160"
                                Aspect="AspectFill"
                                Source="{Binding CoverImage}"
                                BackgroundColor="#333"
                                HorizontalOptions="Fill"
                                VerticalOptions="Fill" />

                            <Label
                                Text="{Binding Title}"
                                FontAttributes="Bold"
                                FontSize="14"
                                HorizontalTextAlignment="Center"
                                LineBreakMode="TailTruncation" />

                            <HorizontalStackLayout
                                Spacing="2"
                                HorizontalOptions="Center">

                                <Label Text="★"
                                       FontSize="14"
                                       TextColor="{Binding Rating, Converter={StaticResource RatingColorConverter}, ConverterParameter=1}" />
                                <Label Text="★"
                                       FontSize="14"
                                       TextColor="{Binding Rating, Converter={StaticResource RatingColorConverter}, ConverterParameter=2}" />
                                <Label Text="★"
                                       FontSize="14"
                                       TextColor="{Binding Rating, Converter={StaticResource RatingColorConverter}, ConverterParameter=3}" />
                                <Label Text="★"
                                       FontSize="14"
                                       TextColor="{Binding Rating, Converter={StaticResource RatingColorConverter}, ConverterParameter=4}" />
                                <Label Text="★"
                                       FontSize="14"
                                       TextColor="{Binding Rating, Converter={StaticResource RatingColorConverter}, ConverterParameter=5}" />
                            </HorizontalStackLayout>

                            <Label
                                Text="{Binding LastOpened, StringFormat='Открывалась: {0:dd.MM.yyyy HH:mm}'}"
                                FontSize="11"
                                TextColor="{StaticResource SubTextColor}"
                                HorizontalTextAlignment="Center" />

                            <Grid ColumnDefinitions="*,Auto" VerticalOptions="Center">
                                <ProgressBar
                                    Grid.Column="0"
                                    Progress="{Binding Progress}"
                                    HeightRequest="4" />
                                <Label
                                    Grid.Column="1"
                                    Text="{Binding RenderProgress, StringFormat='{0:P0}'}"
                                    FontSize="11"
                                    TextColor="{StaticResource SubTextColor}"
                                    Margin="6,0,0,0" />
                            </Grid>

                            <VerticalStackLayout Spacing="4">

                                <Button
                                    Text="Читать"
                                    Command="{Binding BindingContext.OpenBookCommand, Source={x:Reference Root}}"
                                    CommandParameter="{Binding .}"
                                    IsEnabled="{Binding IsReady}" />

                                <Button
                                    Text="Удалить"
                                    BackgroundColor="Crimson"
                                    TextColor="White"
                                    Command="{Binding BindingContext.DeleteBookCommand, Source={x:Reference Root}}"
                                    CommandParameter="{Binding .}" />
                            </VerticalStackLayout>

                        </VerticalStackLayout>

                    </Frame>

                </DataTemplate>
            </CollectionView.ItemTemplate>

        </CollectionView>

    </Grid>
</ContentPage>
